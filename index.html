<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Asistente Canal Corporativo</title>
<link rel="icon" href="favicon.png" type="image/png">

<!-- Tipografía -->
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600&display=swap" rel="stylesheet">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- PDF LIB -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body {
    font-family: 'Sora', sans-serif;
    background-color: #E6EBF2;
    padding: 24px;
    color: #2F3A4F;
}

h1 { color: #3D57C7; }

input, select, button {
    padding: 8px;
    margin-top: 8px;
}

button {
    background: #3D57C7;
    color: #FFFFFF;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* Helpers y alertas */
.helper-adherentes {
    color: #B00020;
    font-size: 0.85rem;
    margin-top: 6px;
    max-width: 1020px;
}

.alerta-warning {
    background-color: #FCF75E;
    border-left: 4px solid #B00020;
    padding: 12px;
    margin: 16px 0;
    font-size: 0.9rem;
    max-width: 1020px;
}

/* TABLERO */
.resumen {
    background: #FFFFFF;
    padding: 16px;
    border-radius: 8px;
    margin: 12px 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 16px;
}

.resumen div { text-align: center; }

.resumen strong {
    display: block;
    font-size: 0.75rem;
    color: #005E5C;
    margin-bottom: 4px;
}

.resumen span {
    font-size: 1.1rem;
    font-weight: 600;
}

/* TABLA */
table {
    border-collapse: collapse;
    width: 100%;
    background: #FFFFFF;
    margin-top: 16px;
}

th, td {
    border: 1px solid #D0D6E2;
    padding: 8px;
    font-size: 0.85rem;
}

th {
    background-color: #3D57C7;
    color: #FFFFFF;
}
</style>
</head>

<body>

<h1>CANAL CORPORATIVO</h1>
<p>Asistente para cotizaciones</p>

<input type="file" id="fileInput" accept=".xlsx"><br>

<input type="text" id="empresaInput" placeholder="Empresa (ej: ACME S.A.)" style="width:300px">

<p class="helper-adherentes">
⚠️ Encabezados requeridos: CUIL | Apellido y nombre | Remuneración | Adherentes<br>
⚠️ En “Adherentes” contar solo cónyuge e hijos.
</p>

<div id="alertaAdherentes" class="alerta-warning" style="display:none;"></div>

<!-- TABLERO -->
<div class="resumen">
    <div>
        <strong>Plan</strong>
        <select id="planGlobal" onchange="actualizarResumen()">
            <option value="D2100">D2100 - $63.859</option>
            <option value="D3100">D3100 - $73.148</option>
            <option value="D4100">D4100 - $84.062</option>
        </select>
    </div>

    <div><strong>Titulares</strong><span id="totalTitulares">0</span></div>
    <div><strong>Adherentes</strong><span id="totalAdherentes">0</span></div>
    <div><strong>Total Cápitas</strong><span id="totalCapitas">0</span></div>
    <div><strong>Costo Bruto</strong>$<span id="costoBruto">0</span></div>
    <div><strong>Total Aportes</strong>$<span id="totalAportes">0</span></div>
    <div><strong>Costo Neto</strong>$<span id="costoNeto">0</span></div>    
</div>

<button onclick="exportarPDF()">Exportar PDF</button>

<!-- TABLA -->
<table>
<thead>
<tr>
    <th>CUIL</th>
    <th>Apellido y nombre</th>
    <th>Remuneración</th>
    <th>Aporte</th>
    <th>Adherentes</th>
</tr>
</thead>
<tbody id="tablaDatos"></tbody>
</table>

<script>
let titulares = [];

const preciosPlanes = {
    D2100: 63859,
    D3100: 73148,
    D4100: 84062
};

/* === TODO TU JS EXISTENTE (SIN CAMBIOS) === */
/* … se mantiene exactamente igual … */

/* === EXPORTAR PDF === */
async function exportarPDF() {
    if (!empresaInput.value) {
        alert("Ingresá el nombre de la empresa");
        return;
    }

    const { PDFDocument, rgb } = PDFLib;

    const pdfBytes = await fetch("plantilla.pdf").then(r => r.arrayBuffer());
    const fontBytes = await fetch("fonts/Sora-Regular.ttf").then(r => r.arrayBuffer());

    const pdfDoc = await PDFDocument.load(pdfBytes);
    const sora = await pdfDoc.embedFont(fontBytes);
    const page = pdfDoc.getPages()[0];

    const draw = (text, x, y, size = 10) => {
        page.drawText(String(text), {
            x, y, size,
            font: sora,
            color: rgb(1,1,1)
        });
    };

    const fecha = new Date().toLocaleDateString("es-AR", {
        day: "numeric",
        month: "long",
        year: "numeric"
    });

    draw(empresaInput.value, 80, 735);
    draw(`Córdoba, ${fecha}`, 380, 720);

    const totalTit = titulares.length;
    const totalAdh = titulares.reduce((s,t)=>s+t.adherentes,0);
    const capitas = totalTit + totalAdh;
    const totalAportes = titulares.reduce((s,t)=>s+t.aporte,0);

    const filas = [
        { plan: "D2100", y: 495 },
        { plan: "D3100", y: 470 },
        { plan: "D4100", y: 445 }
    ];

    filas.forEach(f => {
        const bruto = preciosPlanes[f.plan] * capitas;
        const neto = bruto - totalAportes;

        draw(totalTit, 170, f.y);
        draw(totalAdh, 250, f.y);
        draw(`$${Math.round(bruto).toLocaleString("es-AR")}`, 340, f.y);
        draw(`$${Math.round(totalAportes).toLocaleString("es-AR")}`, 430, f.y);
        draw(`$${Math.round(neto).toLocaleString("es-AR")}`, 520, f.y);
    });

    const bytes = await pdfDoc.save();
    const blob = new Blob([bytes], { type: "application/pdf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Cotizacion_${empresaInput.value}.pdf`;
    link.click();
}
</script>

</body>
</html>
